import{Button,LoadingCover}from"../components/_components.min.js";import{DialogError,DialogConfirm,DialogLanguage,DialogFormPassword}from"../dialogs/_dialogs.min.js";import{HomePage,ChartPage,UserPage}from"./_pages.min.js";import{request,getActiveUser}from"../libs/utils.min.js";import{i18n,setLanguage}from"../i18n/i18n.min.js";import Cookies from"../libs/js-cookie.min.js";export function Root(){let o={user:null,loading:!1,dlgError:{visible:!1,message:""},dlgLogout:{visible:!1,loading:!1},dlgLanguage:{visible:!1,loading:!1},dlgPassword:{visible:!1,loading:!1}};return{view:function(e){let i=e.attrs.page;"string"==typeof i&&""!==i||(i="home");let n=[];0===n.length&&o.dlgError.visible&&n.push(m(DialogError,{message:o.dlgError.message,onAccepted(){o.dlgError.visible=!1}})),0===n.length&&o.dlgLogout.visible&&n.push(m(DialogConfirm,{title:i18n("Logout"),message:i18n("Log out from the application ?"),acceptText:i18n("Yes"),rejectText:i18n("No"),loading:o.dlgLogout.loading,onAccepted(){o.loading=!0,o.dlgLogout.loading=!0,m.redraw(),request("/api/logout","5s",{method:"POST"}).then(()=>{Cookies.remove("session-duit"),localStorage.removeItem("duit-user"),window.location.href="/login"}).catch(e=>{o.dlgError.message=e.message,o.dlgError.visible=!0,o.isLoading=!1,o.dlgLogout.loading=!1,o.dlgLogout.visible=!1,m.redraw()})},onRejected(){o.dlgLogout.visible=!1}})),0===n.length&&o.dlgLanguage.visible&&n.push(m(DialogLanguage,{title:i18n("Change Language"),loading:o.dlgLanguage.loading,onRejected(){o.dlgLanguage.visible=!1},onAccepted(o){setLanguage(o.language),location.reload(!1)}})),0===n.length&&o.dlgPassword.visible&&n.push(m(DialogFormPassword,{title:i18n("Change Password"),loading:o.dlgPassword.loading,onAccepted(e){!function(e){if(e.newPassword!==e.repeatPassword)return o.dlgPassword.visible=!1,o.dlgError.message=i18n("new password doesn't match"),void(o.dlgError.visible=!0);o.loading=!0,o.dlgPassword.loading=!0,m.redraw();let i={method:"PUT",body:JSON.stringify({userId:o.user.id,oldPassword:e.oldPassword,newPassword:e.newPassword})};request("/api/user/password","5s",i).then(()=>{Cookies.remove("session-duit"),localStorage.removeItem("duit-user"),window.location.href="/login"}).catch(e=>{o.dlgError.message=e.message,o.dlgError.visible=!0,o.isLoading=!1,o.dlgPassword.loading=!1,o.dlgPassword.visible=!1,m.redraw()})}(e)},onRejected(){o.dlgPassword.visible=!1}}));let s=[];o.loading&&s.push(m(LoadingCover));let r=function(o,e){let n=e.icon,s=e.href,r=e.caption,a=e.onclick,t="sidebar__button";return"string"!=typeof n&&(n=""),"string"!=typeof s&&(s=""),"string"!=typeof r&&(r=""),"function"!=typeof a&&(a=()=>{}),o===i&&(t+=" sidebar__button--active"),{iconOnly:!0,tooltipPosition:"right",class:t,icon:n,href:s,caption:r,onclick:a}},a=[m(Button,r("home",{icon:"fa-home",caption:i18n("Home"),href:"#!"})),m(Button,r("chart",{icon:"fa-chart-line",caption:i18n("Money chart"),href:"#!/chart"})),m(Button,r("users",{icon:"fa-user-cog",caption:i18n("User management"),href:"#!/users"})),m(".sidebar__spacer"),m(Button,r(null,{icon:"fa-flag",caption:i18n("Change language"),onclick(){o.dlgLanguage.visible=!0}})),m(Button,r(null,{icon:"fa-sign-out-alt",caption:i18n("Logout"),onclick(){o.dlgLogout.visible=!0}}))];return null!=o.user&&a.splice(5,0,m(Button,r(null,{icon:"fa-key",caption:i18n("Change password"),onclick(){o.dlgPassword.visible=!0}}))),m(".root",m(".sidebar",a),m(function(o){switch(o){case"home":return HomePage;case"chart":return ChartPage;case"users":return UserPage;default:return HomePage}}(i),{class:"root__content"}),...n,...s)},oninit:function(){o.user=getActiveUser()}}}