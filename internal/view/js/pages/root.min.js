import{Button,LoadingCover}from"../components/_components.min.js";import{DialogError,DialogConfirm,DialogFormPassword}from"../dialogs/_dialogs.min.js";import{HomePage,ChartPage,UserPage}from"./_pages.min.js";import{request,getActiveUser}from"../libs/utils.min.js";import Cookies from"../libs/js-cookie.min.js";export function Root(){let o={user:null,loading:!1,dlgLogout:{visible:!1,loading:!1},dlgPassword:{visible:!1,loading:!1},dlgError:{visible:!1,message:""}};return{view:function(e){let i=e.attrs.page;"string"==typeof i&&""!==i||(i="home");let r=[];0===r.length&&o.dlgError.visible&&r.push(m(DialogError,{message:o.dlgError.message,onAccepted(){o.dlgError.visible=!1}})),0===r.length&&o.dlgLogout.visible&&r.push(m(DialogConfirm,{title:"Logout",message:"Yakin ingin keluar dari aplikasi ?",acceptText:"Ya",rejectText:"Tidak",loading:o.dlgLogout.loading,onAccepted(){o.loading=!0,o.dlgLogout.loading=!0,m.redraw(),request("/api/logout","5s",{method:"POST"}).then(()=>{Cookies.remove("session-duit"),localStorage.removeItem("user"),window.location.href="/login"}).catch(e=>{o.dlgError.message=e.message,o.dlgError.visible=!0,o.isLoading=!1,o.dlgLogout.loading=!1,o.dlgLogout.visible=!1,m.redraw()})},onRejected(){o.dlgLogout.visible=!1}})),0===r.length&&o.dlgPassword.visible&&r.push(m(DialogFormPassword,{title:"Ganti Password",loading:o.dlgPassword.loading,onAccepted(e){!function(e){if(e.newPassword!==e.repeatPassword)return o.dlgPassword.visible=!1,o.dlgError.message="password baru tidak cocok",void(o.dlgError.visible=!0);o.loading=!0,o.dlgPassword.loading=!0,m.redraw();let i={method:"PUT",body:JSON.stringify({userId:o.user.id,oldPassword:e.oldPassword,newPassword:e.newPassword})};request("/api/user/password","5s",i).then(()=>{Cookies.remove("session-duit"),localStorage.removeItem("user"),window.location.href="/login"}).catch(e=>{o.dlgError.message=e.message,o.dlgError.visible=!0,o.isLoading=!1,o.dlgPassword.loading=!1,o.dlgPassword.visible=!1,m.redraw()})}(e)},onRejected(){o.dlgPassword.visible=!1}}));let s=[];o.loading&&s.push(m(LoadingCover));let t=function(o,e){let r=e.icon,s=e.href,t=e.caption,a=e.onclick,n="sidebar__button";return"string"!=typeof r&&(r=""),"string"!=typeof s&&(s=""),"string"!=typeof t&&(t=""),"function"!=typeof a&&(a=()=>{}),o===i&&(n+=" sidebar__button--active"),{iconOnly:!0,tooltipPosition:"right",class:n,icon:r,href:s,caption:t,onclick:a}},a=[m(Button,t("home",{icon:"fa-home",caption:"Home",href:"#!"})),m(Button,t("chart",{icon:"fa-chart-line",caption:"Grafik keuangan",href:"#!/chart"})),m(Button,t("users",{icon:"fa-user-cog",caption:"Kelola user",href:"#!/users"})),m(".sidebar__spacer"),m(Button,t(null,{icon:"fa-sign-out-alt",caption:"Logout",onclick(){o.dlgLogout.visible=!0}}))];return null!=o.user&&a.splice(4,0,m(Button,t(null,{icon:"fa-key",caption:"Ganti password",onclick(){o.dlgPassword.visible=!0}}))),m(".root",m(".sidebar",a),m(function(o){switch(o){case"home":return HomePage;case"chart":return ChartPage;case"users":return UserPage;default:return HomePage}}(i),{class:"root__content"}),...r,...s)},oninit:function(){o.user=getActiveUser()}}}