import{LoadingCover,UserList}from"../components/_components.min.js";import{DialogError,DialogAlert,DialogConfirm,DialogFormUser}from"../dialogs/_dialogs.min.js";import{request,cloneObject}from"../libs/utils.min.js";import{i18n}from"../i18n/i18n.min.js";export function UserPage(){let e={loading:!1,users:[],selectedUsers:[],usersLoading:!1,dlgError:{message:"",visible:!1},dlgNew:{visible:!1,loading:!1},dlgNewResult:{message:"",visible:!1},dlgEdit:{visible:!1,loading:!1},dlgDelete:{visible:!1,loading:!1},dlgReset:{visible:!1,loading:!1},dlgResetResult:{message:"",visible:!1}};function s(e,s){let l=e.name.toLowerCase(),i=s.name.toLowerCase();return l<i?-1:l>i?1:0}return{view:function(){let l=[];if(0===l.length&&e.dlgError.visible&&l.push(m(DialogError,{message:e.dlgError.message,onAccepted(){e.dlgError.visible=!1}})),0===l.length&&e.dlgNew.visible&&l.push(m(DialogFormUser,{title:i18n("New User"),loading:e.dlgNew.loading,onAccepted(l){!function(l){e.loading=!0,e.dlgNew.loading=!0,m.redraw();let i={method:"POST",body:JSON.stringify(l)};request("/api/user","5s",i).then(l=>{e.selectedUsers=[],e.users.push(l),e.users.sort(s);let i=i18n("User saved with password $password").replace("$password",l.password);e.dlgNewResult.message=i,e.dlgNewResult.visible=!0}).catch(s=>{e.dlgError.message=s.message,e.dlgError.visible=!0}).finally(()=>{e.loading=!1,e.dlgNew.loading=!1,e.dlgNew.visible=!1,m.redraw()})}(l)},onRejected(){e.dlgNew.visible=!1}})),0===l.length&&e.dlgNewResult.visible&&l.push(m(DialogAlert,{title:i18n("New User"),btnText:i18n("OK"),message:e.dlgNewResult.message,onAccepted(){e.dlgNewResult.visible=!1}})),0===l.length&&e.dlgEdit.visible){let i=e.selectedUsers[0],r=e.users[i],t=cloneObject(r);l.push(m(DialogFormUser,{title:i18n("Edit User"),loading:e.dlgEdit.loading,defaultValue:t,onAccepted(l){!function(l){e.loading=!0,e.dlgEdit.loading=!0,m.redraw();let i=e.selectedUsers[0],r=e.users[i],t={method:"PUT",body:JSON.stringify({id:r.id,name:l.name,username:l.username,admin:l.admin})};request("/api/user","5s",t).then(l=>{e.users.splice(i,1,l),e.users.sort(s)}).catch(s=>{e.dlgError.message=s.message,e.dlgError.visible=!0}).finally(()=>{e.loading=!1,e.dlgEdit.loading=!1,e.dlgEdit.visible=!1,m.redraw()})}(l)},onRejected(){e.dlgEdit.visible=!1}}))}if(0===l.length&&e.dlgDelete.visible){let s=i18n("Permanently delete $n users ?").replace("$n",e.selectedUsers.length);l.push(m(DialogConfirm,{title:i18n("Delete User"),message:s,acceptText:i18n("Yes"),rejectText:i18n("No"),loading:e.dlgDelete.loading,onAccepted(){!function(){e.loading=!0,e.dlgDelete.loading=!0,m.redraw();let s=e.selectedUsers.map(s=>e.users[s].id),l={method:"DELETE",body:JSON.stringify(s)};request("/api/users","5s",l).then(()=>{e.selectedUsers.sort((e,s)=>s-e).forEach(s=>{e.users.splice(s,1)}),e.selectedUsers=[]}).catch(s=>{e.dlgError.message=s.message,e.dlgError.visible=!0}).finally(()=>{e.loading=!1,e.dlgDelete.loading=!1,e.dlgDelete.visible=!1,m.redraw()})}()},onRejected(){e.dlgDelete.visible=!1}}))}if(0===l.length&&e.dlgReset.visible){let s=e.selectedUsers[0],i=e.users[s],r=i18n("Reset password for $name ?").replace("$name",i.name);l.push(m(DialogConfirm,{title:i18n("Reset Password"),message:r,acceptText:i18n("Yes"),rejectText:i18n("No"),loading:e.dlgReset.loading,onAccepted(){!function(){e.isLoading=!0,e.dlgReset.loading=!0,m.redraw();let s=e.selectedUsers[0],l=e.users[s],i={method:"PUT",body:JSON.stringify(l.id)};request("/api/user/password/reset","5s",i).then(s=>{e.dlgResetResult.message=i18n("New password: $password").replace("$password",s.password),e.dlgResetResult.visible=!0}).catch(s=>{e.dlgError.message=s.message,e.dlgError.visible=!0}).finally(()=>{e.isLoading=!1,e.dlgReset.loading=!1,e.dlgReset.visible=!1,m.redraw()})}()},onRejected(){e.dlgReset.visible=!1}}))}0===l.length&&e.dlgResetResult.visible&&l.push(m(DialogAlert,{title:i18n("Reset Password"),btnText:i18n("OK"),message:e.dlgResetResult.message,onAccepted(){e.dlgResetResult.visible=!1}}));let i=[];e.loading&&i.push(m(LoadingCover));let r=m(UserList,{class:"user-page__user-list",loading:e.usersLoading,users:e.users,selection:e.selectedUsers,onNewClicked(){e.dlgNew.visible=!0},onEditClicked(){e.dlgEdit.visible=!0},onDeleteClicked(){e.dlgDelete.visible=!0},onResetClicked(){e.dlgReset.visible=!0}});return m(".home-page",r,...l,...i)},oncreate:function(){e.loading=!0,e.usersLoading=!0,m.redraw(),request("/api/users","5s").then(s=>{e.users=s,e.selectedUsers=[]}).catch(s=>{e.dlgError.message=s.message,e.dlgError.visible=!0}).finally(()=>{e.loading=!1,e.usersLoading=!1,m.redraw()})}}}