import{LoadingCover,UserList}from"../components/_components.min.js";import{DialogError,DialogAlert,DialogConfirm,DialogFormUser}from"../dialogs/_dialogs.min.js";import{request,cloneObject,getActiveUser}from"../libs/utils.min.js";import{i18n}from"../i18n/i18n.min.js";export function UserPage(){let e={loading:!1,activeUser:null,users:[],selectedUsers:[],usersLoading:!1,dlgError:{message:"",visible:!1},dlgNew:{visible:!1,loading:!1},dlgNewResult:{message:"",visible:!1},dlgEdit:{visible:!1,loading:!1},dlgDelete:{visible:!1,loading:!1},dlgReset:{visible:!1,loading:!1},dlgResetResult:{userId:0,message:"",visible:!1},dlgLogin:{title:"",message:"",visible:!1}};function s(e,s){let i=e.name.toLowerCase(),l=s.name.toLowerCase();return i<l?-1:i>l?1:0}return{view:function(){let i=[];if(0===i.length&&e.dlgError.visible&&i.push(m(DialogError,{message:e.dlgError.message,onAccepted(){e.dlgError.visible=!1}})),0===i.length&&e.dlgNew.visible&&i.push(m(DialogFormUser,{title:i18n("New User"),loading:e.dlgNew.loading,onAccepted(i){!function(i){e.loading=!0,e.dlgNew.loading=!0,m.redraw();let l={method:"POST",body:JSON.stringify(i)};request("/api/user","5s",l).then(i=>{e.selectedUsers=[],e.users.push(i),e.users.sort(s);let l=i18n("User saved with password $password").replace("$password",i.password);e.dlgNewResult.message=l,e.dlgNewResult.visible=!0}).catch(s=>{e.dlgError.message=s.message,e.dlgError.visible=!0}).finally(()=>{e.loading=!1,e.dlgNew.loading=!1,e.dlgNew.visible=!1,m.redraw()})}(i)},onRejected(){e.dlgNew.visible=!1}})),0===i.length&&e.dlgNewResult.visible&&i.push(m(DialogAlert,{title:i18n("New User"),btnText:i18n("OK"),message:e.dlgNewResult.message,onAccepted(){e.dlgNewResult.visible=!1}})),0===i.length&&e.dlgEdit.visible){let l=e.selectedUsers[0],t=e.users[l],r=cloneObject(t);i.push(m(DialogFormUser,{title:i18n("Edit User"),loading:e.dlgEdit.loading,defaultValue:r,onAccepted(i){!function(i){e.loading=!0,e.dlgEdit.loading=!0,m.redraw();let l=e.selectedUsers[0],t=e.users[l],r={method:"PUT",body:JSON.stringify({id:t.id,name:i.name,username:i.username,admin:i.admin})};request("/api/user","5s",r).then(r=>{if(null!=e.activeUser&&e.activeUser.id===t.id&&(e.activeUser.username!==i.username||e.activeUser.admin!==i.admin))return e.dlgLogin.title=i18n("Edit User"),e.dlgLogin.message=i18n("Data for active user has been updated, please login again"),void(e.dlgLogin.visible=!0);e.users.splice(l,1,r),e.users.sort(s)}).catch(s=>{e.dlgError.message=s.message,e.dlgError.visible=!0}).finally(()=>{e.loading=!1,e.dlgEdit.loading=!1,e.dlgEdit.visible=!1,m.redraw()})}(i)},onRejected(){e.dlgEdit.visible=!1}}))}if(0===i.length&&e.dlgDelete.visible){let s=i18n("Permanently delete $n users ?").replace("$n",e.selectedUsers.length);i.push(m(DialogConfirm,{title:i18n("Delete User"),message:s,acceptText:i18n("Yes"),rejectText:i18n("No"),loading:e.dlgDelete.loading,onAccepted(){!function(){e.loading=!0,e.dlgDelete.loading=!0,m.redraw();let s=e.selectedUsers.map(s=>e.users[s].id),i={method:"DELETE",body:JSON.stringify(s)};request("/api/users","5s",i).then(()=>{if(null!=e.activeUser&&-1!==s.indexOf(e.activeUser.id))return e.dlgLogin.title=i18n("Delete User"),e.dlgLogin.message=i18n("Current active user has been deleted, please login again"),void(e.dlgLogin.visible=!0);e.selectedUsers.sort((e,s)=>s-e).forEach(s=>{e.users.splice(s,1)}),e.selectedUsers=[]}).catch(s=>{e.dlgError.message=s.message,e.dlgError.visible=!0}).finally(()=>{e.loading=!1,e.dlgDelete.loading=!1,e.dlgDelete.visible=!1,m.redraw()})}()},onRejected(){e.dlgDelete.visible=!1}}))}if(0===i.length&&e.dlgReset.visible){let s=e.selectedUsers[0],l=e.users[s],t=i18n("Reset password for $name ?").replace("$name",l.name);i.push(m(DialogConfirm,{title:i18n("Reset Password"),message:t,acceptText:i18n("Yes"),rejectText:i18n("No"),loading:e.dlgReset.loading,onAccepted(){!function(){e.isLoading=!0,e.dlgReset.loading=!0,m.redraw();let s=e.selectedUsers[0],i=e.users[s],l={method:"PUT",body:JSON.stringify(i.id)};request("/api/user/password/reset","5s",l).then(s=>{e.dlgResetResult.userId=i.id,e.dlgResetResult.message=i18n("New password: $password").replace("$password",s.password),e.dlgResetResult.visible=!0}).catch(s=>{e.dlgError.message=s.message,e.dlgError.visible=!0}).finally(()=>{e.isLoading=!1,e.dlgReset.loading=!1,e.dlgReset.visible=!1,m.redraw()})}()},onRejected(){e.dlgReset.visible=!1}}))}0===i.length&&e.dlgResetResult.visible&&i.push(m(DialogAlert,{title:i18n("Reset Password"),btnText:i18n("OK"),message:e.dlgResetResult.message,onAccepted(){e.dlgResetResult.visible=!1,null!=e.activeUser&&e.activeUser.id===e.dlgResetResult.userId&&(e.dlgLogin.title=i18n("Reset Password"),e.dlgLogin.message=i18n("Password for active user has been reset, please login again"),e.dlgLogin.visible=!0)}})),0===i.length&&e.dlgLogin.visible&&i.push(m(DialogAlert,{title:e.dlgLogin.title,message:e.dlgLogin.message,btnText:i18n("OK"),onAccepted(){window.location.href="/login"}}));let l=[];e.loading&&l.push(m(LoadingCover));let t=m(UserList,{class:"user-page__user-list",loading:e.usersLoading,users:e.users,selection:e.selectedUsers,onNewClicked(){e.dlgNew.visible=!0},onEditClicked(){e.dlgEdit.visible=!0},onDeleteClicked(){e.dlgDelete.visible=!0},onResetClicked(){e.dlgReset.visible=!0}});return m(".home-page",t,...i,...l)},oncreate:function(){e.loading=!0,e.usersLoading=!0,m.redraw(),request("/api/users","5s").then(s=>{e.users=s,e.selectedUsers=[]}).catch(s=>{e.dlgError.message=s.message,e.dlgError.visible=!0}).finally(()=>{e.loading=!1,e.usersLoading=!1,m.redraw()})},oninit:function(){e.activeUser=getActiveUser()}}}