import{LoadingCover,AccountList,EntryList}from"../components/_components.min.js";import{DialogError,DialogConfirm,DialogFormAccount,DialogEntryType,DialogFormEntry}from"../dialogs/_dialogs.min.js";import{request,cloneObject}from"../libs/utils.min.js";import{i18n}from"../i18n/i18n.min.js";import{Big}from"../libs/big.min.js";export function HomePage(){let e={loading:!1,accounts:[],selectedAccounts:[],accountsLoading:!1,activeAccount:null,entries:[],selectedEntries:[],entriesLoading:!1,pagination:{page:1,maxPage:1},dlgError:{message:"",visible:!1},dlgNewAccount:{visible:!1,loading:!1},dlgEditAccount:{visible:!1,loading:!1},dlgDeleteAccount:{visible:!1,loading:!1},dlgEntryType:{visible:!1},dlgNewEntry:{visible:!1,loading:!1,type:0},dlgEditEntry:{visible:!1,loading:!1},dlgDeleteEntry:{visible:!1,loading:!1}};function t(e,t){let n=e.name.toLowerCase(),i=t.name.toLowerCase();return n<i?-1:n>i?1:0}function n(e){let t=e.split("-");return{year:parseInt(t[0],10)||1,month:parseInt(t[1],10)||1,day:parseInt(t[2],10)||1}}function i(e,t){let i=n(e.date),c=n(t.date),l=365*i.year+30*i.month+i.day;return 365*c.year+30*c.month+c.day-l}function c(t){return null==e.activeAccount||t.id!==e.activeAccount.id}function l(){if(null==e.activeAccount)return;e.loading=!0,e.entriesLoading=!0,m.redraw();let t=new URL("/api/entries",document.baseURI);t.searchParams.set("page",e.pagination.page),t.searchParams.set("account",e.activeAccount.id),request(t.toString(),"5s").then(t=>{e.entries=t.entries,e.selectedEntries=[],e.pagination.page=t.page,e.pagination.maxPage=t.maxPage}).catch(t=>{e.dlgError.message=t.message,e.dlgError.visible=!0}).finally(()=>{e.loading=!1,e.entriesLoading=!1,m.redraw()})}return{view:function(n){let o=[];if(0===o.length&&e.dlgError.visible&&o.push(m(DialogError,{message:e.dlgError.message,onAccepted(){e.dlgError.visible=!1}})),0===o.length&&e.dlgNewAccount.visible&&o.push(m(DialogFormAccount,{title:i18n("New Account"),loading:e.dlgNewAccount.loading,onAccepted(n){!function(n){e.loading=!0,e.dlgNewAccount.loading=!0,m.redraw();let i={method:"POST",body:JSON.stringify(n)};request("/api/account","5s",i).then(n=>{e.selectedAccounts=[],e.accounts.push(n),e.accounts.sort(t)}).catch(t=>{e.dlgError.message=t.message,e.dlgError.visible=!0}).finally(()=>{e.loading=!1,e.dlgNewAccount.loading=!1,e.dlgNewAccount.visible=!1,m.redraw()})}(n)},onRejected(){e.dlgNewAccount.visible=!1}})),0===o.length&&e.dlgEditAccount.visible){let n=e.selectedAccounts[0],i=e.accounts[n],c=cloneObject(i);o.push(m(DialogFormAccount,{title:i18n("Edit Account"),loading:e.dlgEditAccount.loading,defaultValue:c,onAccepted(n){!function(n){e.loading=!0,e.dlgEditAccount.loading=!0,m.redraw();let i=e.selectedAccounts[0],c=e.accounts[i],l={method:"PUT",body:JSON.stringify({id:c.id,name:n.name,initialAmount:n.initialAmount})};request("/api/account","5s",l).then(n=>{e.accounts.splice(i,1,n),e.accounts.sort(t)}).catch(t=>{e.dlgError.message=t.message,e.dlgError.visible=!0}).finally(()=>{e.loading=!1,e.dlgEditAccount.loading=!1,e.dlgEditAccount.visible=!1,m.redraw()})}(n)},onRejected(){e.dlgEditAccount.visible=!1}}))}if(0===o.length&&e.dlgDeleteAccount.visible){let t=i18n("Permanently delete $n accounts ?").replace("$n",e.selectedAccounts.length);o.push(m(DialogConfirm,{title:i18n("Delete Account"),message:t,acceptText:i18n("Yes"),rejectText:i18n("No"),loading:e.dlgDeleteAccount.loading,onAccepted(){!function(){e.loading=!0,e.dlgDeleteAccount.loading=!0,m.redraw();let t=e.selectedAccounts.map(t=>e.accounts[t].id),n={method:"DELETE",body:JSON.stringify(t)};request("/api/accounts","5s",n).then(()=>{if(e.selectedAccounts.sort((e,t)=>t-e).forEach(t=>{e.accounts.splice(t,1)}),e.selectedAccounts=[],null!=e.activeAccount){-1!==t.findIndex(t=>t===e.activeAccount.id)&&(e.activeAccount=null)}}).catch(t=>{e.dlgError.message=t.message,e.dlgError.visible=!0}).finally(()=>{e.loading=!1,e.dlgDeleteAccount.loading=!1,e.dlgDeleteAccount.visible=!1,m.redraw()})}()},onRejected(){e.dlgDeleteAccount.visible=!1}}))}if(0===o.length&&e.dlgEntryType.visible&&o.push(m(DialogEntryType,{title:i18n("Entry Type"),onRejected(){e.dlgEntryType.visible=!1},onAccepted(t){e.dlgNewEntry.type=t.type,e.dlgNewEntry.visible=!0,e.dlgEntryType.visible=!1}})),0===o.length&&e.dlgNewEntry.visible){let t="";switch(e.dlgNewEntry.type){case 1:t=i18n("New Income");break;case 2:t=i18n("New Expense");break;case 3:t=i18n("New Transfer")}o.push(m(DialogFormEntry,{title:t,loading:e.dlgNewEntry.loading,accounts:e.accounts.filter(c),entryType:e.dlgNewEntry.type,onAccepted(t){!function(t){if(null==e.activeAccount)return;t.accountId=e.activeAccount.id,e.loading=!0,e.dlgNewEntry.loading=!0,m.redraw();let n={method:"POST",body:JSON.stringify(t)};request("/api/entry","5s",n).then(t=>{e.selectedEntries=[],e.entries.unshift(t),e.entries.sort(i);let n=e.accounts.findIndex(e=>e.id===t.accountId),c=e.accounts.findIndex(e=>e.id===t.affectedAccountId),l=1===t.type?Big(t.amount):Big(t.amount).times(-1),o=e.accounts[n];if(o.total=Big(o.total).plus(l).toString(),e.accounts[n]=o,e.activeAccount=o,c>=0){let t=e.accounts[c];t.total=Big(t.total).minus(l).toString(),e.accounts[c]=t}}).catch(t=>{e.dlgError.message=t.message,e.dlgError.visible=!0}).finally(()=>{e.loading=!1,e.dlgNewEntry.loading=!1,e.dlgNewEntry.visible=!1,m.redraw()})}(t)},onRejected(){e.dlgNewEntry.visible=!1}}))}if(0===o.length&&e.dlgEditEntry.visible){let t=e.selectedEntries[0],n=e.entries[t],l=cloneObject(n),a="";switch(n.type){case 1:a=i18n("Edit Income");break;case 2:a=i18n("Edit Expense");break;case 3:a=i18n("Edit Transfer")}o.push(m(DialogFormEntry,{title:a,loading:e.dlgEditEntry.loading,accounts:e.accounts.filter(c),entryType:n.type,defaultValue:l,onAccepted(t){!function(t){e.loading=!0,e.dlgEditEntry.loading=!0,m.redraw();let n=e.selectedEntries[0],c=e.entries[n],l={method:"PUT",body:JSON.stringify({id:c.id,affectedAccountId:t.affectedAccountId,description:t.description,amount:t.amount,date:t.date})};request("/api/entry","5s",l).then(t=>{e.selectedEntries=[],e.entries.splice(n,1,t),e.entries.sort(i);let l=e.accounts.findIndex(e=>e.id===t.accountId),o=Big(t.amount),a=Big(c.amount),s=e.accounts[l];if(1!==t.type&&(o=o.times(-1),a=a.times(-1)),s.total=Big(s.total).minus(a).plus(o).toString(),e.accounts[l]=s,e.activeAccount=s,3!==t.type)return;let d=e.accounts.findIndex(e=>e.id===t.affectedAccountId),r=e.accounts.findIndex(e=>e.id===c.affectedAccountId);if(d===r){let t=e.accounts[d];t.total=Big(t.total).plus(a).minus(o).toString(),e.accounts[d]=t}else{let t=e.accounts[d],n=e.accounts[r];t.total=Big(t.total).minus(o),n.total=Big(n.total).plus(a),e.accounts[d]=t,e.accounts[r]=n}}).catch(t=>{e.dlgError.message=t.message,e.dlgError.visible=!0}).finally(()=>{e.loading=!1,e.dlgEditEntry.loading=!1,e.dlgEditEntry.visible=!1,m.redraw()})}(t)},onRejected(){e.dlgEditEntry.visible=!1}}))}if(0===o.length&&e.dlgDeleteEntry.visible){let t=i18n("Permanently delete $n entries ?").replace("$n",e.selectedEntries.length);o.push(m(DialogConfirm,{title:i18n("Delete Entry"),message:t,acceptText:i18n("Yes"),rejectText:i18n("No"),loading:e.dlgDeleteEntry.loading,onAccepted(){!function(){e.loading=!0,e.dlgDeleteEntry.loading=!0,m.redraw();let t=e.selectedEntries.map(t=>e.entries[t].id),n={method:"DELETE",body:JSON.stringify(t)};request("/api/entries","5s",n).then(()=>{let t={};e.selectedEntries.sort((e,t)=>t-e).forEach(n=>{let i=e.entries[n],c=Big(i.amount);if(3===i.type){let e=t[i.accountId]||Big(0),n=t[i.affectedAccountId]||Big(0);e=e.minus(c),t[i.accountId]=e,n=n.plus(c),t[i.affectedAccountId]=n}else{let e=t[i.accountId]||Big(0);e=1===i.type?e.plus(c):e.minus(c),t[i.accountId]=e}e.entries.splice(n,1)}),e.selectedEntries=[];for(const n in t){let i=parseInt(n,10)||0,c=e.accounts.findIndex(e=>e.id===i),l=e.accounts[c];null!=l&&(l.total=Big(l.total).minus(t[i]),e.accounts[c]=l)}l()}).catch(t=>{e.dlgError.message=t.message,e.dlgError.visible=!0}).finally(()=>{e.loading=!1,e.dlgDeleteEntry.loading=!1,e.dlgDeleteEntry.visible=!1,m.redraw()})}()},onRejected(){e.dlgDeleteEntry.visible=!1}}))}let a=[];e.loading&&a.push(m(LoadingCover));let s=[];return s.push(m(AccountList,{class:"home-page__account-list",loading:e.accountsLoading,accounts:e.accounts,selection:e.selectedAccounts,onNewClicked(){e.dlgNewAccount.visible=!0},onEditClicked(){e.dlgEditAccount.visible=!0},onDeleteClicked(){e.dlgDeleteAccount.visible=!0},onItemClicked(t){let n=e.activeAccount||{};t.id!==n.id&&(e.activeAccount=t,e.pagination.maxPage=1,e.pagination.page=1,l())}})),null!=e.activeAccount&&s.push(m(EntryList,{class:"home-page__entry-list",loading:e.entriesLoading,account:e.activeAccount,entries:e.entries,selection:e.selectedEntries,currentPage:e.pagination.page,maxPage:e.pagination.maxPage,onNewClicked(){e.dlgEntryType.visible=!0},onEditClicked(){e.dlgEditEntry.visible=!0},onDeleteClicked(){e.dlgDeleteEntry.visible=!0},onPageChanged(t){e.pagination.page=t,l()}})),m(".home-page",...s,...o,...a)},oncreate:function(){e.loading=!0,e.accountsLoading=!0,m.redraw(),request("/api/accounts","5s").then(t=>{e.accounts=t,e.selectedAccounts=[],e.activeAccount=null}).catch(t=>{e.dlgError.message=t.message,e.dlgError.visible=!0}).finally(()=>{e.loading=!1,e.accountsLoading=!1,m.redraw()})}}}