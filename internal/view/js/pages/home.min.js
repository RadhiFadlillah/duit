import{Button,LoadingCover,AccountList}from"../components/_components.min.js";import{DialogError,DialogConfirm,DialogFormAccount,DialogFormEntry,DialogListAccount}from"../dialogs/_dialogs.min.js";import{request,cloneObject,mergeObject}from"../libs/utils.min.js";import{Big}from"../libs/big.min.js";export function Home(){let e={loading:!1,accounts:[],selectedAccounts:[],accountsLoading:!1,entriesLoading:!1,activeAccount:{id:0,name:"",total:"0",initialAmount:"0",entries:[]},pagination:{page:1,maxPage:1},dlgError:{message:"",visible:!1},dlgNewAccount:{visible:!1,loading:!1},dlgEditAccount:{visible:!1,loading:!1},dlgDeleteAccount:{visible:!1,loading:!1},dlgNewEntry:{visible:!1,loading:!1},dlgTransferEntry:{visible:!1,loading:!1,entry:null}};function t(e){return Number(e).toLocaleString("id-ID",{maximumFractionDigits:0})}function n(e){let t=e.split("-");return{year:parseInt(t[0],10)||1,month:parseInt(t[1],10)||1,day:parseInt(t[2],10)||1}}let i="5s";function a(){e.loading=!0,e.entriesLoading=!0,m.redraw();let t=new URL(`/api/account/${e.activeAccount.id}`,document.baseURI);t.searchParams.set("page",e.pagination.page),request(t.toString(),i).then(t=>{e.pagination.page=t.page,e.pagination.maxPage=t.maxPage,e.activeAccount.entries=t.entries}).catch(t=>{e.dlgError.message=t.message,e.dlgError.visible=!0}).finally(()=>{e.loading=!1,e.entriesLoading=!1,m.redraw()})}function o(t){e.loading=!0,e.dlgNewEntry.loading=!0,e.dlgTransferEntry.loading=!0,m.redraw(),t.accountId=e.activeAccount.id;let a={method:"POST",body:JSON.stringify(t)};request("/api/entry",i,a).then(t=>{e.activeAccount.entries.unshift(t),e.activeAccount.entries.sort((e,t)=>{let i=n(e.entryDate),a=n(t.entryDate),o=365*i.year+30*i.month+i.day;return 365*a.year+30*a.month+a.day-o});let i=Big(t.amount);1!==t.entryType&&(i=i.times(-1));let a=e.accounts.findIndex(t=>t.id===e.activeAccount.id),o=e.accounts.findIndex(e=>e.id===t.affectedAccountId);if(a>=0){let t=e.accounts[a],n=Big(t.total).plus(i).toString();e.activeAccount.total=n,e.accounts[a].total=n}if(o>=0){let t=e.accounts[o],n=Big(t.total).minus(i).toString();e.accounts[o].total=n}}).catch(t=>{e.dlgError.message=t.message,e.dlgError.visible=!0}).finally(()=>{e.loading=!1,e.dlgNewEntry.loading=!1,e.dlgNewEntry.visible=!1,e.dlgTransferEntry.loading=!1,e.dlgTransferEntry.visible=!1,m.redraw()})}return{view:function(c){let l=[];if(0===l.length&&e.dlgError.visible&&l.push(m(DialogError,{message:e.dlgError.message,onAccepted(){e.dlgError.visible=!1}})),0===l.length&&e.dlgNewAccount.visible&&l.push(m(DialogFormAccount,{title:"Akun Baru",loading:e.dlgNewAccount.loading,onAccepted(t){!function(t){e.loading=!0,e.dlgNewAccount.loading=!0,m.redraw();let n={method:"POST",body:JSON.stringify(t)};request("/api/account",i,n).then(t=>{e.accounts.push(t),e.accounts.sort((e,t)=>{let n=e.name.toLowerCase(),i=t.name.toLowerCase();return n<i?-1:n>i?1:0})}).catch(t=>{e.dlgError.message=t.message,e.dlgError.visible=!0}).finally(()=>{e.loading=!1,e.dlgNewAccount.loading=!1,e.dlgNewAccount.visible=!1,m.redraw()})}(t)},onRejected(){e.dlgNewAccount.visible=!1}})),0===l.length&&e.dlgEditAccount.visible){let t=e.selectedAccounts[0],n=e.accounts[t],a=cloneObject(n);l.push(m(DialogFormAccount,{title:"Edit Akun",loading:e.dlgEditAccount.loading,defaultValue:a,onAccepted(t){!function(t){e.loading=!0,e.dlgEditAccount.loading=!0,m.redraw();let n=e.selectedAccounts[0],a=e.accounts[n],o={method:"PUT",body:JSON.stringify({id:a.id,name:t.name,initialAmount:t.initialAmount})};request("/api/account",i,o).then(t=>{e.accounts.splice(n,1,t)}).catch(t=>{e.dlgError.message=t.message,e.dlgError.visible=!0}).finally(()=>{e.loading=!1,e.dlgEditAccount.loading=!1,e.dlgEditAccount.visible=!1,m.redraw()})}(t)},onRejected(){e.dlgEditAccount.visible=!1}}))}if(0===l.length&&e.dlgDeleteAccount.visible&&l.push(m(DialogConfirm,{title:"Delete Akun",message:`Yakin ingin menghapus ${e.selectedAccounts.length} akun ?`,acceptText:"Ya",rejectText:"Tidak",loading:e.dlgDeleteAccount.loading,onAccepted(){!function(){e.loading=!0,e.dlgDeleteAccount.loading=!0,m.redraw();let t=e.selectedAccounts.map(t=>e.accounts[t].id),n={method:"DELETE",body:JSON.stringify(t)};request("/api/accounts",i,n).then(()=>{e.selectedAccounts.sort((e,t)=>t-e).forEach(t=>{e.accounts.splice(t,1)}),e.selectedAccounts.splice(0,e.selectedAccounts.length)}).catch(t=>{e.dlgError.message=t.message,e.dlgError.visible=!0}).finally(()=>{e.loading=!1,e.dlgDeleteAccount.loading=!1,e.dlgDeleteAccount.visible=!1,m.redraw()})}()},onRejected(){e.dlgDeleteAccount.visible=!1}})),0===l.length&&e.dlgNewEntry.visible&&l.push(m(DialogFormEntry,{title:"Entry Baru",loading:e.dlgNewEntry.loading,onRejected(){e.dlgNewEntry.visible=!1},onAccepted(t){3===t.entryType?(""===t.description.trim()&&(t.description=null),e.dlgTransferEntry.entry=t,e.dlgTransferEntry.visible=!0,e.dlgNewEntry.visible=!1):o(t)}})),0===l.length&&e.dlgTransferEntry.visible){let t=e.accounts.filter(t=>t.id!==e.activeAccount.id).map(e=>({caption:e.name,value:String(e.id)}));l.push(m(DialogListAccount,{title:"Entry Transfer",loading:e.dlgTransferEntry.loading,accounts:t,onRejected(){e.dlgTransferEntry.visible=!1},onAccepted(t){let n=e.dlgTransferEntry.entry;null!=n&&"object"==typeof n||(n={}),n.affectedAccountId=t.affectedAccountId,o(n)}}))}let r=[];e.loading&&r.push(m(LoadingCover));let s=[m(AccountList,{class:"home-account-list",loading:e.accountsLoading,accounts:e.accounts,selection:e.selectedAccounts,onNewClicked(){e.dlgNewAccount.visible=!0},onEditClicked(){e.dlgEditAccount.visible=!0},onDeleteClicked(){e.dlgDeleteAccount.visible=!0},onItemClicked(t){let n=e.activeAccount||{};t.id!==n.id&&(e.activeAccount=t,a())}})],d="",g=[];if(null!=e.activeAccount&&(d=`${e.activeAccount.name}, ${t(e.activeAccount.total)}`,e.entriesLoading?g=[m("i.fas.fa-fw.fa-spin.fa-spinner.home-list__loading-sign")]:0===e.activeAccount.entries.length?g=[m("p.home-list__empty-message","Belum ada entry yang terdaftar")]:(e.activeAccount.entries.forEach((i,a)=>{let o="",c=Big(i.amount),l=i.description;if(1===i.entryType)o="entry--income";else if(2===i.entryType)o="entry--expense",c=c.times(-1);else{let t=e.activeAccount.id===i.affectedAccountId,n=t?i.accountId:i.affectedAccountId,a=e.accounts.find(e=>e.id===n),r=a?a.name:"";o="entry--transfer",t?l=`Masuk dari ${r}`:(l=`Pindah ke ${r}`,c=c.times(-1))}let r=e.activeAccount.entries[a-1];null!=r&&i.entryDate===r.entryDate||g.push(m(".entry__date",function(e){let t=n(e),i="";switch(t.month){case 1:i="Januari";break;case 2:i="Februari";break;case 3:i="Maret";break;case 4:i="April";break;case 5:i="Mei";break;case 6:i="Juni";break;case 7:i="Juli";break;case 8:i="Agustus";break;case 9:i="September";break;case 10:i="Oktober";break;case 11:i="November";break;case 12:i="Desember"}return`${t.day} ${i} ${t.year}`}(i.entryDate))),g.push(m(".entry",m("p.entry__description",l),m("p.entry__amount",{class:o},t(c))))}),g.push(m(".entry-list__space")))),e.pagination.maxPage>1){let t={iconOnly:!0,tooltipPosition:"top",class:"entry-list__footer__button"},n={first:e.pagination.page>2,prev:e.pagination.page>1,next:e.pagination.page<e.pagination.maxPage,last:e.pagination.page<e.pagination.maxPage-1};for(const t in n)n[t]=!e.entriesLoading&&n[t];g.push(m(".entry-list__footer",m(Button,mergeObject(t,{icon:"fa-angle-double-left",caption:"Halaman pertama",enabled:n.first,onclick(){e.pagination.page=1,a()}})),m(Button,mergeObject(t,{icon:"fa-angle-left",caption:"Halaman sebelumnya",enabled:n.prev,onclick(){e.pagination.page--,a()}})),m("p.entry-list__footer__page",`${e.pagination.page} / ${e.pagination.maxPage}`),m(Button,mergeObject(t,{icon:"fa-angle-right",caption:"Halaman selanjutnya",enabled:n.next,onclick(){e.pagination.page++,a()}})),m(Button,mergeObject(t,{icon:"fa-angle-double-right",caption:"Halaman terakhir",enabled:n.last,onclick(){e.pagination.page=e.pagination.maxPage,a()}}))))}return null!=e.activeAccount&&s.push(m(".home-list.entry-list",m(".home-list__header.entry-list__header",m("p.home-list__header__title",d),m(Button,{iconOnly:!0,class:"home-list__header__button",icon:"fa-pen",caption:"Edit akun",onclick(){e.dlgEditAccount.visible=!0}}),m(Button,{iconOnly:!0,class:"home-list__header__button",icon:"fa-trash-alt",caption:"Delete akun",onclick(){e.dlgDeleteAccount.visible=!0}}),m(Button,{iconOnly:!0,class:"home-list__header__button",icon:"fa-plus-circle",caption:"Tambah entry",onclick(){e.dlgNewEntry.visible=!0}})),...g)),m(".home",...s,...l,...r)},oncreate:function(){e.loading=!0,e.accountsLoading=!0,m.redraw(),request("/api/accounts",i).then(t=>{e.accounts=t,e.activeAccount=null}).catch(t=>{e.dlgError.message=t.message,e.dlgError.visible=!0}).finally(()=>{e.loading=!1,e.accountsLoading=!1,m.redraw()})}}}