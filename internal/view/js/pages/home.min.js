import{Button,LoadingCover,AccountList,EntryList}from"../components/_components.min.js";import{DialogError,DialogConfirm,DialogFormAccount,DialogEntryType,DialogFormEntry}from"../dialogs/_dialogs.min.js";import{request,cloneObject,getDateParts,mergeObject}from"../libs/utils.min.js";import{Big}from"../libs/big.min.js";export function Home(){let e={loading:!1,accounts:[],selectedAccounts:[],accountsLoading:!1,activeAccount:null,entries:[],selectedEntries:[],entriesLoading:!1,pagination:{page:1,maxPage:1},dlgError:{message:"",visible:!1},dlgNewAccount:{visible:!1,loading:!1},dlgEditAccount:{visible:!1,loading:!1},dlgDeleteAccount:{visible:!1,loading:!1},dlgEntryType:{visible:!1},dlgNewEntry:{visible:!1,loading:!1,type:0}},t="5s";function n(){if(null==e.activeAccount)return;e.loading=!0,e.entriesLoading=!0,m.redraw();let n=new URL("/api/entries",document.baseURI);n.searchParams.set("page",e.pagination.page),n.searchParams.set("account",e.activeAccount.id),request(n.toString(),t).then(t=>{e.entries=t.entries,e.selectedEntries=[],e.pagination.page=t.page,e.pagination.maxPage=t.maxPage}).catch(t=>{e.dlgError.message=t.message,e.dlgError.visible=!0}).finally(()=>{e.loading=!1,e.entriesLoading=!1,m.redraw()})}return{view:function(i){let c=[];if(0===c.length&&e.dlgError.visible&&c.push(m(DialogError,{message:e.dlgError.message,onAccepted(){e.dlgError.visible=!1}})),0===c.length&&e.dlgNewAccount.visible&&c.push(m(DialogFormAccount,{title:"Akun Baru",loading:e.dlgNewAccount.loading,onAccepted(n){!function(n){e.loading=!0,e.dlgNewAccount.loading=!0,m.redraw();let i={method:"POST",body:JSON.stringify(n)};request("/api/account",t,i).then(t=>{e.selectedAccounts=[],e.accounts.push(t),e.accounts.sort((e,t)=>{let n=e.name.toLowerCase(),i=t.name.toLowerCase();return n<i?-1:n>i?1:0})}).catch(t=>{e.dlgError.message=t.message,e.dlgError.visible=!0}).finally(()=>{e.loading=!1,e.dlgNewAccount.loading=!1,e.dlgNewAccount.visible=!1,m.redraw()})}(n)},onRejected(){e.dlgNewAccount.visible=!1}})),0===c.length&&e.dlgEditAccount.visible){let n=e.selectedAccounts[0],i=e.accounts[n],o=cloneObject(i);c.push(m(DialogFormAccount,{title:"Edit Akun",loading:e.dlgEditAccount.loading,defaultValue:o,onAccepted(n){!function(n){e.loading=!0,e.dlgEditAccount.loading=!0,m.redraw();let i=e.selectedAccounts[0],c=e.accounts[i],o={method:"PUT",body:JSON.stringify({id:c.id,name:n.name,initialAmount:n.initialAmount})};request("/api/account",t,o).then(t=>{e.accounts.splice(i,1,t)}).catch(t=>{e.dlgError.message=t.message,e.dlgError.visible=!0}).finally(()=>{e.loading=!1,e.dlgEditAccount.loading=!1,e.dlgEditAccount.visible=!1,m.redraw()})}(n)},onRejected(){e.dlgEditAccount.visible=!1}}))}if(0===c.length&&e.dlgDeleteAccount.visible&&c.push(m(DialogConfirm,{title:"Delete Akun",message:`Yakin ingin menghapus ${e.selectedAccounts.length} akun ?`,acceptText:"Ya",rejectText:"Tidak",loading:e.dlgDeleteAccount.loading,onAccepted(){!function(){e.loading=!0,e.dlgDeleteAccount.loading=!0,m.redraw();let n=e.selectedAccounts.map(t=>e.accounts[t].id),i={method:"DELETE",body:JSON.stringify(n)};request("/api/accounts",t,i).then(()=>{if(e.selectedAccounts.sort((e,t)=>t-e).forEach(t=>{e.accounts.splice(t,1)}),e.selectedAccounts=[],null!=e.activeAccount){-1!==n.findIndex(t=>t===e.activeAccount.id)&&(e.activeAccount=null)}}).catch(t=>{e.dlgError.message=t.message,e.dlgError.visible=!0}).finally(()=>{e.loading=!1,e.dlgDeleteAccount.loading=!1,e.dlgDeleteAccount.visible=!1,m.redraw()})}()},onRejected(){e.dlgDeleteAccount.visible=!1}})),0===c.length&&e.dlgEntryType.visible&&c.push(m(DialogEntryType,{title:"Jenis Entry",onRejected(){e.dlgEntryType.visible=!1},onAccepted(t){e.dlgNewEntry.type=t.type,e.dlgNewEntry.visible=!0,e.dlgEntryType.visible=!1}})),0===c.length&&e.dlgNewEntry.visible){let n="";switch(e.dlgNewEntry.type){case 1:n="Pemasukan Baru";break;case 2:n="Pengeluaran Baru";break;case 3:n="Transfer Baru"}c.push(m(DialogFormEntry,{title:n,loading:e.dlgNewEntry.loading,accounts:e.accounts,entryType:e.dlgNewEntry.type,onAccepted(n){!function(n){if(null==e.activeAccount)return;n.accountId=e.activeAccount.id,e.loading=!0,e.dlgNewEntry.loading=!0,m.redraw();let i={method:"POST",body:JSON.stringify(n)};request("/api/entry",t,i).then(t=>{e.selectedEntries=[],e.entries.unshift(t),e.entries.sort((e,t)=>{let n=getDateParts(e.date),i=getDateParts(t.date),c=365*n.year+30*n.month+n.day;return 365*i.year+30*i.month+i.day-c});let n=e.accounts.findIndex(e=>e.id===t.accountId),i=e.accounts.findIndex(e=>e.id===t.affectedAccountId),c=1===t.type?Big(t.amount):Big(t.amount).times(-1),o=e.accounts[n];if(o.total=Big(o.total).plus(c).toString(),e.accounts[n]=o,e.activeAccount=o,i>=0){let t=e.accounts[i];t.total=Big(t.total).minus(c).toString(),e.accounts[i]=t}}).catch(t=>{e.dlgError.message=t.message,e.dlgError.visible=!0}).finally(()=>{e.loading=!1,e.dlgNewEntry.loading=!1,e.dlgNewEntry.visible=!1,m.redraw()})}(n)},onRejected(){e.dlgNewEntry.visible=!1}}))}let o=[];e.loading&&o.push(m(LoadingCover));let l=[];return l.push(m(AccountList,{class:"home-account-list",loading:e.accountsLoading,accounts:e.accounts,selection:e.selectedAccounts,onNewClicked(){e.dlgNewAccount.visible=!0},onEditClicked(){e.dlgEditAccount.visible=!0},onDeleteClicked(){e.dlgDeleteAccount.visible=!0},onItemClicked(t){let i=e.activeAccount||{};t.id!==i.id&&(e.activeAccount=t,n())}})),null!=e.activeAccount&&l.push(m(EntryList,{class:"home-entry-list",loading:e.entriesLoading,account:e.activeAccount,entries:e.entries,selection:e.selectedEntries,currentPage:e.pagination.page,maxPage:e.pagination.maxPage,onNewClicked(){e.dlgEntryType.visible=!0},onEditClicked(){},onDeleteClicked(){},onItemClicked(e){},onPageChanged(t){e.pagination.page=t,n()}})),m(".home",...l,...c,...o)},oncreate:function(){e.loading=!0,e.accountsLoading=!0,m.redraw(),request("/api/accounts",t).then(t=>{e.accounts=t,e.selectedAccounts=[],e.activeAccount=null}).catch(t=>{e.dlgError.message=t.message,e.dlgError.visible=!0}).finally(()=>{e.loading=!1,e.accountsLoading=!1,m.redraw()})}}}