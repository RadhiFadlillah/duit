import{Button,LoadingCover}from"../components/_components.min.js";import{DialogError}from"../dialogs/_dialogs.min.js";import{request,mergeObject}from"../libs/utils.min.js";import{Big}from"../libs/big.min.js";export function Home(){let e={accountsLoading:!1,entriesLoading:!1,accounts:[],activeAccount:{id:0,name:"",total:"0",entries:[]},pagination:{page:1,maxPage:1},dlgError:{message:"",visible:!1}};function a(e){return Number(e).toLocaleString("id-ID",{maximumFractionDigits:0})}let t="5s";function n(){e.entriesLoading=!0,m.redraw();let a=new URL(`/api/account/${e.activeAccount.id}`,document.baseURI);a.searchParams.set("page",e.pagination.page),request(a.toString(),t).then(a=>{e.pagination.page=a.page,e.pagination.maxPage=a.maxPage,e.activeAccount.entries=a.entries}).catch(a=>{e.dlgError.message=a.message,e.dlgError.visible=!0}).finally(()=>{e.entriesLoading=!1,m.redraw()})}return{view:function(t){let i=[];0===i.length&&e.dlgError.visible&&i.push(m(DialogError,{message:e.dlgError.message,onAccepted(){e.dlgError.visible=!1}}));let o=[];(e.accountsLoading||e.entriesLoading)&&o.push(m(LoadingCover));let c=[],r="Daftar Akun",s=[];if(!e.accountsLoading&&e.accounts.length>0){r=`Total ${a(e.accounts.reduce((e,a)=>e.plus(Number(a.total)),Big(0)))}`}s=e.accountsLoading?[m("i.fas.fa-fw.fa-spin.fa-spinner.home-list__loading-sign")]:0===e.accounts.length?[m("p.home-list__empty-message","Belum ada akun terdaftar")]:e.accounts.map(t=>{let i={};return t.id!==e.activeAccount.id&&(i.onclick=()=>{e.activeAccount.id=t.id,e.activeAccount.name=t.name,e.activeAccount.total=t.total,n(t.id)}),m(".account",i,m("p.account__name",t.name),m("p.account__amount",a(t.total)))}),c.push(m(".home-list.account-list",m(".home-list__header.account-list__header",m("p.home-list__header__title",r),m(Button,{iconOnly:!0,class:"home-list__header__button",icon:"fa-plus-circle",caption:"Akun baru"})),...s));let l=`${e.activeAccount.name}, ${a(e.activeAccount.total)}`,u=[];if(e.entriesLoading?u=[m("i.fas.fa-fw.fa-spin.fa-spinner.home-list__loading-sign")]:0===e.activeAccount.entries.length?u=[m("p.home-list__empty-message","Belum ada entry yang terdaftar")]:(e.activeAccount.entries.forEach((t,n)=>{let i="",o=Big(t.amount),c=t.description;if(1===t.entryType)i="entry--income";else if(2===t.entryType)i="entry--expense",o=o.times(-1);else{let a=e.activeAccount.id===t.affectedAccountId,n=a?t.accountId:t.affectedAccountId,r=e.accounts.find(e=>e.id===n),s=r?r.name:"";i="entry--transfer",a?c=`Masuk dari ${s}`:(c=`Pindah ke ${s}`,o=o.times(-1))}let r=e.activeAccount.entries[n-1];null!=r&&t.entryDate===r.entryDate||u.push(m(".entry__date",function(e){let a=e.split("-"),t=parseInt(a[0],10)||1,n=parseInt(a[1],10)||1,i=parseInt(a[2],10)||1,o="";switch(n){case 1:o="Januari";break;case 2:o="Februari";break;case 3:o="Maret";break;case 4:o="April";break;case 5:o="Mei";break;case 6:o="Juni";break;case 7:o="Juli";break;case 8:o="Agustus";break;case 9:o="September";break;case 10:o="Oktober";break;case 11:o="November";break;case 12:o="Desember"}return`${i} ${o} ${t}`}(t.entryDate))),u.push(m(".entry",m("p.entry__description",c),m("p.entry__amount",{class:i},a(o))))}),u.push(m(".entry-list__space"))),e.pagination.maxPage>1){let a={iconOnly:!0,tooltipPosition:"top",class:"entry-list__footer__button"},t={first:e.pagination.page>2,prev:e.pagination.page>1,next:e.pagination.page<e.pagination.maxPage,last:e.pagination.page<e.pagination.maxPage-1};for(const a in t)t[a]=!e.entriesLoading&&t[a];u.push(m(".entry-list__footer",m(Button,mergeObject(a,{icon:"fa-angle-double-left",caption:"Halaman pertama",enabled:t.first,onclick(){e.pagination.page=1,n()}})),m(Button,mergeObject(a,{icon:"fa-angle-left",caption:"Halaman sebelumnya",enabled:t.prev,onclick(){e.pagination.page--,n()}})),m("p.entry-list__footer__page",`${e.pagination.page} / ${e.pagination.maxPage}`),m(Button,mergeObject(a,{icon:"fa-angle-right",caption:"Halaman selanjutnya",enabled:t.next,onclick(){e.pagination.page++,n()}})),m(Button,mergeObject(a,{icon:"fa-angle-double-right",caption:"Halaman terakhir",enabled:t.last,onclick(){e.pagination.page=e.pagination.maxPage,n()}}))))}return 0!==e.activeAccount.id&&c.push(m(".home-list.entry-list",m(".home-list__header.entry-list__header",m("p.home-list__header__title",l),m(Button,{iconOnly:!0,class:"home-list__header__button",icon:"fa-pen",caption:"Edit akun"}),m(Button,{iconOnly:!0,class:"home-list__header__button",icon:"fa-trash-alt",caption:"Delete akun"}),m(Button,{iconOnly:!0,class:"home-list__header__button",icon:"fa-plus-circle",caption:"Tambah entry"})),...u)),m(".home",...c,...i,...o)},oncreate:function(){e.accountsLoading=!0,m.redraw(),request("/api/accounts",t).then(a=>{e.accounts=a}).catch(a=>{e.dlgError.message=a.message,e.dlgError.visible=!0}).finally(()=>{e.accountsLoading=!1,m.redraw()})}}}