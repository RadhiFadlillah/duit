import{Button,LoadingCover}from"../components/_components.min.js";import{DialogError,DialogConfirm,DialogFormAccount,DialogFormEntry,DialogListAccount}from"../dialogs/_dialogs.min.js";import{request,mergeObject}from"../libs/utils.min.js";import{Big}from"../libs/big.min.js";export function Home(){let e={loading:!1,accountsLoading:!1,entriesLoading:!1,accounts:[],activeAccount:{id:0,name:"",total:"0",initialAmount:"0",entries:[]},pagination:{page:1,maxPage:1},dlgError:{message:"",visible:!1},dlgNewAccount:{visible:!1,loading:!1},dlgEditAccount:{visible:!1,loading:!1},dlgDeleteAccount:{visible:!1,loading:!1},dlgNewEntry:{visible:!1,loading:!1},dlgTransferEntry:{visible:!1,loading:!1,entry:null}};function t(e){return Number(e).toLocaleString("id-ID",{maximumFractionDigits:0})}function n(e){let t=e.split("-");return{year:parseInt(t[0],10)||1,month:parseInt(t[1],10)||1,day:parseInt(t[2],10)||1}}let a="5s";function i(){e.loading=!0,e.entriesLoading=!0,m.redraw();let t=new URL(`/api/account/${e.activeAccount.id}`,document.baseURI);t.searchParams.set("page",e.pagination.page),request(t.toString(),a).then(t=>{e.pagination.page=t.page,e.pagination.maxPage=t.maxPage,e.activeAccount.entries=t.entries}).catch(t=>{e.dlgError.message=t.message,e.dlgError.visible=!0}).finally(()=>{e.loading=!1,e.entriesLoading=!1,m.redraw()})}function o(t){e.loading=!0,e.dlgNewEntry.loading=!0,e.dlgTransferEntry.loading=!0,m.redraw(),t.accountId=e.activeAccount.id;let i={method:"POST",body:JSON.stringify(t)};request("/api/entry",a,i).then(t=>{e.activeAccount.entries.unshift(t),e.activeAccount.entries.sort((e,t)=>{let a=n(e.entryDate),i=n(t.entryDate),o=365*a.year+30*a.month+a.day;return 365*i.year+30*i.month+i.day-o});let a=Big(t.amount);1!==t.entryType&&(a=a.times(-1));let i=e.accounts.findIndex(t=>t.id===e.activeAccount.id),o=e.accounts.findIndex(e=>e.id===t.affectedAccountId);if(i>=0){let t=e.accounts[i],n=Big(t.total).plus(a).toString();e.activeAccount.total=n,e.accounts[i].total=n}if(o>=0){let t=e.accounts[o],n=Big(t.total).minus(a).toString();e.accounts[o].total=n}}).catch(t=>{e.dlgError.message=t.message,e.dlgError.visible=!0}).finally(()=>{e.loading=!1,e.dlgNewEntry.loading=!1,e.dlgNewEntry.visible=!1,e.dlgTransferEntry.loading=!1,e.dlgTransferEntry.visible=!1,m.redraw()})}return{view:function(c){let l=[];if(0===l.length&&e.dlgError.visible&&l.push(m(DialogError,{message:e.dlgError.message,onAccepted(){e.dlgError.visible=!1}})),0===l.length&&e.dlgNewAccount.visible&&l.push(m(DialogFormAccount,{title:"Akun Baru",loading:e.dlgNewAccount.loading,onAccepted(t){!function(t){e.loading=!0,e.dlgNewAccount.loading=!0,m.redraw();let n={method:"POST",body:JSON.stringify(t)};request("/api/account",a,n).then(t=>{e.accounts.push(t),e.accounts.sort((e,t)=>{let n=e.name.toLowerCase(),a=t.name.toLowerCase();return n<a?-1:n>a?1:0})}).catch(t=>{e.dlgError.message=t.message,e.dlgError.visible=!0}).finally(()=>{e.loading=!1,e.dlgNewAccount.loading=!1,e.dlgNewAccount.visible=!1,m.redraw()})}(t)},onRejected(){e.dlgNewAccount.visible=!1}})),0===l.length&&e.dlgEditAccount.visible){let t={name:e.activeAccount.name,initialAmount:e.activeAccount.initialAmount};l.push(m(DialogFormAccount,{title:"Edit Akun",loading:e.dlgEditAccount.loading,defaultValue:t,onAccepted(t){!function(t){e.loading=!0,e.dlgEditAccount.loading=!0,m.redraw();let n={method:"PUT",body:JSON.stringify({id:e.activeAccount.id,name:t.name,initialAmount:t.initialAmount})};request("/api/account",a,n).then(t=>{let n=e.accounts.findIndex(e=>e.id===t.id),a=t;e.accounts.splice(n,1,a),e.activeAccount.name=a.name,e.activeAccount.total=a.total,e.activeAccount.initialAmount=a.initialAmount}).catch(t=>{e.dlgError.message=t.message,e.dlgError.visible=!0}).finally(()=>{e.loading=!1,e.dlgEditAccount.loading=!1,e.dlgEditAccount.visible=!1,m.redraw()})}(t)},onRejected(){e.dlgEditAccount.visible=!1}}))}if(0===l.length&&e.dlgDeleteAccount.visible&&l.push(m(DialogConfirm,{title:"Delete Akun",message:`Yakin ingin menghapus akun "${e.activeAccount.name}" ?`,acceptText:"Ya",rejectText:"Tidak",loading:e.dlgDeleteAccount.loading,onAccepted(){!function(){e.loading=!0,e.dlgDeleteAccount.loading=!0,m.redraw();let t=`/api/account/${e.activeAccount.id}`;request(t,a,{method:"DELETE"}).then(()=>{let t=e.accounts.findIndex(t=>t.id===e.activeAccount.id);e.accounts.splice(t,1),e.activeAccount.id=0}).catch(t=>{e.dlgError.message=t.message,e.dlgError.visible=!0}).finally(()=>{e.loading=!1,e.dlgDeleteAccount.loading=!1,e.dlgDeleteAccount.visible=!1,m.redraw()})}()},onRejected(){e.dlgDeleteAccount.visible=!1}})),0===l.length&&e.dlgNewEntry.visible&&l.push(m(DialogFormEntry,{title:"Entry Baru",loading:e.dlgNewEntry.loading,onRejected(){e.dlgNewEntry.visible=!1},onAccepted(t){3===t.entryType?(""===t.description.trim()&&(t.description=null),e.dlgTransferEntry.entry=t,e.dlgTransferEntry.visible=!0,e.dlgNewEntry.visible=!1):o(t)}})),0===l.length&&e.dlgTransferEntry.visible){let t=e.accounts.filter(t=>t.id!==e.activeAccount.id).map(e=>({caption:e.name,value:String(e.id)}));l.push(m(DialogListAccount,{title:"Entry Transfer",loading:e.dlgTransferEntry.loading,accounts:t,onRejected(){e.dlgTransferEntry.visible=!1},onAccepted(t){let n=e.dlgTransferEntry.entry;null!=n&&"object"==typeof n||(n={}),n.affectedAccountId=t.affectedAccountId,o(n)}}))}let r=[];e.loading&&r.push(m(LoadingCover));let s=[],d="Daftar Akun",g=[];if(!e.accountsLoading&&e.accounts.length>0){d=`Total ${t(e.accounts.reduce((e,t)=>e.plus(Number(t.total)),Big(0)))}`}g=e.accountsLoading?[m("i.fas.fa-fw.fa-spin.fa-spinner.home-list__loading-sign")]:0===e.accounts.length?[m("p.home-list__empty-message","Belum ada akun terdaftar")]:e.accounts.map(n=>{let a={};return n.id!==e.activeAccount.id&&(a.onclick=()=>{e.activeAccount=n,i()}),m(".account",a,m("p.account__name",n.name),m("p.account__amount",t(n.total)))}),s.push(m(".home-list.account-list",m(".home-list__header.account-list__header",m("p.home-list__header__title",d),m(Button,{iconOnly:!0,class:"home-list__header__button",icon:"fa-plus-circle",caption:"Akun baru",onclick(){e.dlgNewAccount.visible=!0}})),...g));let u=`${e.activeAccount.name}, ${t(e.activeAccount.total)}`,p=[];if(e.entriesLoading?p=[m("i.fas.fa-fw.fa-spin.fa-spinner.home-list__loading-sign")]:0===e.activeAccount.entries.length?p=[m("p.home-list__empty-message","Belum ada entry yang terdaftar")]:(e.activeAccount.entries.forEach((a,i)=>{let o="",c=Big(a.amount),l=a.description;if(1===a.entryType)o="entry--income";else if(2===a.entryType)o="entry--expense",c=c.times(-1);else{let t=e.activeAccount.id===a.affectedAccountId,n=t?a.accountId:a.affectedAccountId,i=e.accounts.find(e=>e.id===n),r=i?i.name:"";o="entry--transfer",t?l=`Masuk dari ${r}`:(l=`Pindah ke ${r}`,c=c.times(-1))}let r=e.activeAccount.entries[i-1];null!=r&&a.entryDate===r.entryDate||p.push(m(".entry__date",function(e){let t=n(e),a="";switch(t.month){case 1:a="Januari";break;case 2:a="Februari";break;case 3:a="Maret";break;case 4:a="April";break;case 5:a="Mei";break;case 6:a="Juni";break;case 7:a="Juli";break;case 8:a="Agustus";break;case 9:a="September";break;case 10:a="Oktober";break;case 11:a="November";break;case 12:a="Desember"}return`${t.day} ${a} ${t.year}`}(a.entryDate))),p.push(m(".entry",m("p.entry__description",l),m("p.entry__amount",{class:o},t(c))))}),p.push(m(".entry-list__space"))),e.pagination.maxPage>1){let t={iconOnly:!0,tooltipPosition:"top",class:"entry-list__footer__button"},n={first:e.pagination.page>2,prev:e.pagination.page>1,next:e.pagination.page<e.pagination.maxPage,last:e.pagination.page<e.pagination.maxPage-1};for(const t in n)n[t]=!e.entriesLoading&&n[t];p.push(m(".entry-list__footer",m(Button,mergeObject(t,{icon:"fa-angle-double-left",caption:"Halaman pertama",enabled:n.first,onclick(){e.pagination.page=1,i()}})),m(Button,mergeObject(t,{icon:"fa-angle-left",caption:"Halaman sebelumnya",enabled:n.prev,onclick(){e.pagination.page--,i()}})),m("p.entry-list__footer__page",`${e.pagination.page} / ${e.pagination.maxPage}`),m(Button,mergeObject(t,{icon:"fa-angle-right",caption:"Halaman selanjutnya",enabled:n.next,onclick(){e.pagination.page++,i()}})),m(Button,mergeObject(t,{icon:"fa-angle-double-right",caption:"Halaman terakhir",enabled:n.last,onclick(){e.pagination.page=e.pagination.maxPage,i()}}))))}return 0!==e.activeAccount.id&&s.push(m(".home-list.entry-list",m(".home-list__header.entry-list__header",m("p.home-list__header__title",u),m(Button,{iconOnly:!0,class:"home-list__header__button",icon:"fa-pen",caption:"Edit akun",onclick(){e.dlgEditAccount.visible=!0}}),m(Button,{iconOnly:!0,class:"home-list__header__button",icon:"fa-trash-alt",caption:"Delete akun",onclick(){e.dlgDeleteAccount.visible=!0}}),m(Button,{iconOnly:!0,class:"home-list__header__button",icon:"fa-plus-circle",caption:"Tambah entry",onclick(){e.dlgNewEntry.visible=!0}})),...p)),m(".home",...s,...l,...r)},oncreate:function(){e.loading=!0,e.accountsLoading=!0,m.redraw(),request("/api/accounts",a).then(t=>{e.accounts=t}).catch(t=>{e.dlgError.message=t.message,e.dlgError.visible=!0}).finally(()=>{e.loading=!1,e.accountsLoading=!1,m.redraw()})}}}