import{Button,LoadingCover,AccountList,EntryList}from"../components/_components.min.js";import{DialogError,DialogConfirm,DialogFormAccount,DialogEntryType,DialogFormEntry}from"../dialogs/_dialogs.min.js";import{request,cloneObject,getDateParts,mergeObject}from"../libs/utils.min.js";import{Big}from"../libs/big.min.js";export function Home(){let e={loading:!1,accounts:[],selectedAccounts:[],accountsLoading:!1,activeAccount:null,entries:[],selectedEntries:[],entriesLoading:!1,pagination:{page:1,maxPage:1},dlgError:{message:"",visible:!1},dlgNewAccount:{visible:!1,loading:!1},dlgEditAccount:{visible:!1,loading:!1},dlgDeleteAccount:{visible:!1,loading:!1},dlgEntryType:{visible:!1},dlgNewEntry:{visible:!1,loading:!1,type:0},dlgEditEntry:{visible:!1,loading:!1},dlgDeleteEntry:{visible:!1,loading:!1}};function t(e,t){let n=e.name.toLowerCase(),i=t.name.toLowerCase();return n<i?-1:n>i?1:0}function n(e,t){let n=getDateParts(e.date),i=getDateParts(t.date),c=365*n.year+30*n.month+n.day;return 365*i.year+30*i.month+i.day-c}function i(t){return null==e.activeAccount||t.id!==e.activeAccount.id}let c="5s";function l(){if(null==e.activeAccount)return;e.loading=!0,e.entriesLoading=!0,m.redraw();let t=new URL("/api/entries",document.baseURI);t.searchParams.set("page",e.pagination.page),t.searchParams.set("account",e.activeAccount.id),request(t.toString(),c).then(t=>{e.entries=t.entries,e.selectedEntries=[],e.pagination.page=t.page,e.pagination.maxPage=t.maxPage}).catch(t=>{e.dlgError.message=t.message,e.dlgError.visible=!0}).finally(()=>{e.loading=!1,e.entriesLoading=!1,m.redraw()})}return{view:function(o){let a=[];if(0===a.length&&e.dlgError.visible&&a.push(m(DialogError,{message:e.dlgError.message,onAccepted(){e.dlgError.visible=!1}})),0===a.length&&e.dlgNewAccount.visible&&a.push(m(DialogFormAccount,{title:"Akun Baru",loading:e.dlgNewAccount.loading,onAccepted(n){!function(n){e.loading=!0,e.dlgNewAccount.loading=!0,m.redraw();let i={method:"POST",body:JSON.stringify(n)};request("/api/account",c,i).then(n=>{e.selectedAccounts=[],e.accounts.push(n),e.accounts.sort(t)}).catch(t=>{e.dlgError.message=t.message,e.dlgError.visible=!0}).finally(()=>{e.loading=!1,e.dlgNewAccount.loading=!1,e.dlgNewAccount.visible=!1,m.redraw()})}(n)},onRejected(){e.dlgNewAccount.visible=!1}})),0===a.length&&e.dlgEditAccount.visible){let t=e.selectedAccounts[0],n=e.accounts[t],i=cloneObject(n);a.push(m(DialogFormAccount,{title:"Edit Akun",loading:e.dlgEditAccount.loading,defaultValue:i,onAccepted(t){!function(t){e.loading=!0,e.dlgEditAccount.loading=!0,m.redraw();let n=e.selectedAccounts[0],i=e.accounts[n],l={method:"PUT",body:JSON.stringify({id:i.id,name:t.name,initialAmount:t.initialAmount})};request("/api/account",c,l).then(t=>{e.accounts.splice(n,1,t)}).catch(t=>{e.dlgError.message=t.message,e.dlgError.visible=!0}).finally(()=>{e.loading=!1,e.dlgEditAccount.loading=!1,e.dlgEditAccount.visible=!1,m.redraw()})}(t)},onRejected(){e.dlgEditAccount.visible=!1}}))}if(0===a.length&&e.dlgDeleteAccount.visible&&a.push(m(DialogConfirm,{title:"Delete Akun",message:`Yakin ingin menghapus ${e.selectedAccounts.length} akun ?`,acceptText:"Ya",rejectText:"Tidak",loading:e.dlgDeleteAccount.loading,onAccepted(){!function(){e.loading=!0,e.dlgDeleteAccount.loading=!0,m.redraw();let t=e.selectedAccounts.map(t=>e.accounts[t].id),n={method:"DELETE",body:JSON.stringify(t)};request("/api/accounts",c,n).then(()=>{if(e.selectedAccounts.sort((e,t)=>t-e).forEach(t=>{e.accounts.splice(t,1)}),e.selectedAccounts=[],null!=e.activeAccount){-1!==t.findIndex(t=>t===e.activeAccount.id)&&(e.activeAccount=null)}}).catch(t=>{e.dlgError.message=t.message,e.dlgError.visible=!0}).finally(()=>{e.loading=!1,e.dlgDeleteAccount.loading=!1,e.dlgDeleteAccount.visible=!1,m.redraw()})}()},onRejected(){e.dlgDeleteAccount.visible=!1}})),0===a.length&&e.dlgEntryType.visible&&a.push(m(DialogEntryType,{title:"Jenis Entry",onRejected(){e.dlgEntryType.visible=!1},onAccepted(t){e.dlgNewEntry.type=t.type,e.dlgNewEntry.visible=!0,e.dlgEntryType.visible=!1}})),0===a.length&&e.dlgNewEntry.visible){let t="";switch(e.dlgNewEntry.type){case 1:t="Pemasukan Baru";break;case 2:t="Pengeluaran Baru";break;case 3:t="Transfer Baru"}a.push(m(DialogFormEntry,{title:t,loading:e.dlgNewEntry.loading,accounts:e.accounts.filter(i),entryType:e.dlgNewEntry.type,onAccepted(t){!function(t){if(null==e.activeAccount)return;t.accountId=e.activeAccount.id,e.loading=!0,e.dlgNewEntry.loading=!0,m.redraw();let i={method:"POST",body:JSON.stringify(t)};request("/api/entry",c,i).then(t=>{e.selectedEntries=[],e.entries.unshift(t),e.entries.sort(n);let i=e.accounts.findIndex(e=>e.id===t.accountId),c=e.accounts.findIndex(e=>e.id===t.affectedAccountId),l=1===t.type?Big(t.amount):Big(t.amount).times(-1),o=e.accounts[i];if(o.total=Big(o.total).plus(l).toString(),e.accounts[i]=o,e.activeAccount=o,c>=0){let t=e.accounts[c];t.total=Big(t.total).minus(l).toString(),e.accounts[c]=t}}).catch(t=>{e.dlgError.message=t.message,e.dlgError.visible=!0}).finally(()=>{e.loading=!1,e.dlgNewEntry.loading=!1,e.dlgNewEntry.visible=!1,m.redraw()})}(t)},onRejected(){e.dlgNewEntry.visible=!1}}))}if(0===a.length&&e.dlgEditEntry.visible){let t=e.selectedEntries[0],l=e.entries[t],o=cloneObject(l),s="";switch(l.type){case 1:s="Edit Pemasukan";break;case 2:s="Edit Pengeluaran";break;case 3:s="Edit Transfer"}a.push(m(DialogFormEntry,{title:s,loading:e.dlgEditEntry.loading,accounts:e.accounts.filter(i),entryType:l.type,defaultValue:o,onAccepted(t){!function(t){e.loading=!0,e.dlgEditEntry.loading=!0,m.redraw();let i=e.selectedEntries[0],l=e.entries[i],o={method:"PUT",body:JSON.stringify({id:l.id,affectedAccountId:t.affectedAccountId,description:t.description,amount:t.amount,date:t.date})};request("/api/entry",c,o).then(t=>{e.selectedEntries=[],e.entries.splice(i,1,t),e.entries.sort(n);let c=e.accounts.findIndex(e=>e.id===t.accountId),o=Big(t.amount),a=Big(l.amount),s=e.accounts[c];if(1!==t.type&&(o=o.times(-1),a=a.times(-1)),s.total=Big(s.total).minus(a).plus(o).toString(),e.accounts[c]=s,e.activeAccount=s,3!==t.type)return;let d=e.accounts.findIndex(e=>e.id===t.affectedAccountId),r=e.accounts.findIndex(e=>e.id===l.affectedAccountId);if(d===r){let t=e.accounts[d];t.total=Big(t.total).plus(a).minus(o).toString(),e.accounts[d]=t}else{let t=e.accounts[d],n=e.accounts[r];t.total=Big(t.total).minus(o),n.total=Big(n.total).plus(a),e.accounts[d]=t,e.accounts[r]=n}}).catch(t=>{e.dlgError.message=t.message,e.dlgError.visible=!0}).finally(()=>{e.loading=!1,e.dlgEditEntry.loading=!1,e.dlgEditEntry.visible=!1,m.redraw()})}(t)},onRejected(){e.dlgEditEntry.visible=!1}}))}0===a.length&&e.dlgDeleteEntry.visible&&a.push(m(DialogConfirm,{title:"Delete Entry",message:`Yakin ingin menghapus ${e.selectedEntries.length} entry ?`,acceptText:"Ya",rejectText:"Tidak",loading:e.dlgDeleteEntry.loading,onAccepted(){!function(){e.loading=!0,e.dlgDeleteEntry.loading=!0,m.redraw();let t=e.selectedEntries.map(t=>e.entries[t].id),n={method:"DELETE",body:JSON.stringify(t)};request("/api/entries",c,n).then(()=>{let t={};e.selectedEntries.sort((e,t)=>t-e).forEach(n=>{let i=e.entries[n],c=Big(i.amount);if(3===i.type){let e=t[i.accountId]||Big(0),n=t[i.affectedAccountId]||Big(0);e=e.minus(c),t[i.accountId]=e,n=n.plus(c),t[i.affectedAccountId]=n}else{let e=t[i.accountId]||Big(0);e=1===i.type?e.plus(c):e.minus(c),t[i.accountId]=e}e.entries.splice(n,1)}),e.selectedEntries=[];for(const n in t){let i=parseInt(n,10)||0,c=e.accounts.findIndex(e=>e.id===i),l=e.accounts[c];null!=l&&(l.total=Big(l.total).minus(t[i]),e.accounts[c]=l)}l()}).catch(t=>{e.dlgError.message=t.message,e.dlgError.visible=!0}).finally(()=>{e.loading=!1,e.dlgDeleteEntry.loading=!1,e.dlgDeleteEntry.visible=!1,m.redraw()})}()},onRejected(){e.dlgDeleteEntry.visible=!1}}));let s=[];e.loading&&s.push(m(LoadingCover));let d=[];return d.push(m(AccountList,{class:"home-account-list",loading:e.accountsLoading,accounts:e.accounts,selection:e.selectedAccounts,onNewClicked(){e.dlgNewAccount.visible=!0},onEditClicked(){e.dlgEditAccount.visible=!0},onDeleteClicked(){e.dlgDeleteAccount.visible=!0},onItemClicked(t){let n=e.activeAccount||{};t.id!==n.id&&(e.activeAccount=t,l())}})),null!=e.activeAccount&&d.push(m(EntryList,{class:"home-entry-list",loading:e.entriesLoading,account:e.activeAccount,entries:e.entries,selection:e.selectedEntries,currentPage:e.pagination.page,maxPage:e.pagination.maxPage,onNewClicked(){e.dlgEntryType.visible=!0},onEditClicked(){e.dlgEditEntry.visible=!0},onDeleteClicked(){e.dlgDeleteEntry.visible=!0},onItemClicked(e){},onPageChanged(t){e.pagination.page=t,l()}})),m(".home",...d,...a,...s)},oncreate:function(){e.loading=!0,e.accountsLoading=!0,m.redraw(),request("/api/accounts",c).then(t=>{e.accounts=t,e.selectedAccounts=[],e.activeAccount=null}).catch(t=>{e.dlgError.message=t.message,e.dlgError.visible=!0}).finally(()=>{e.loading=!1,e.accountsLoading=!1,m.redraw()})}}}