import{Button,LoadingCover}from"../components/_components.min.js";import{DialogError,DialogConfirm,DialogFormAccount}from"../dialogs/_dialogs.min.js";import{request,mergeObject}from"../libs/utils.min.js";import{Big}from"../libs/big.min.js";export function Home(){let e={loading:!1,accountsLoading:!1,entriesLoading:!1,accounts:[],activeAccount:{id:0,name:"",total:"0",initialAmount:"0",entries:[]},pagination:{page:1,maxPage:1},dlgError:{message:"",visible:!1},dlgNewAccount:{visible:!1,loading:!1},dlgEditAccount:{visible:!1,loading:!1},dlgDeleteAccount:{visible:!1,loading:!1}};function t(e){return Number(e).toLocaleString("id-ID",{maximumFractionDigits:0})}let n="5s";function a(){e.loading=!0,e.entriesLoading=!0,m.redraw();let t=new URL(`/api/account/${e.activeAccount.id}`,document.baseURI);t.searchParams.set("page",e.pagination.page),request(t.toString(),n).then(t=>{e.pagination.page=t.page,e.pagination.maxPage=t.maxPage,e.activeAccount.entries=t.entries}).catch(t=>{e.dlgError.message=t.message,e.dlgError.visible=!0}).finally(()=>{e.loading=!1,e.entriesLoading=!1,m.redraw()})}return{view:function(i){let o=[];if(0===o.length&&e.dlgError.visible&&o.push(m(DialogError,{message:e.dlgError.message,onAccepted(){e.dlgError.visible=!1}})),0===o.length&&e.dlgNewAccount.visible&&o.push(m(DialogFormAccount,{title:"Akun Baru",loading:e.dlgNewAccount.loading,onAccepted(t){!function(t){e.loading=!0,e.dlgNewAccount.loading=!0,m.redraw();let a={method:"POST",body:JSON.stringify(t)};request("/api/account",n,a).then(t=>{e.accounts.push(t),e.accounts.sort((e,t)=>{let n=e.name.toLowerCase(),a=t.name.toLowerCase();return n<a?-1:n>a?1:0})}).catch(t=>{e.dlgError.message=t.message,e.dlgError.visible=!0}).finally(()=>{e.loading=!1,e.dlgNewAccount.loading=!1,e.dlgNewAccount.visible=!1,m.redraw()})}(t)},onRejected(){e.dlgNewAccount.visible=!1}})),0===o.length&&e.dlgEditAccount.visible){let t={name:e.activeAccount.name,initialAmount:e.activeAccount.initialAmount};o.push(m(DialogFormAccount,{title:"Edit Akun",loading:e.dlgEditAccount.loading,defaultValue:t,onAccepted(t){!function(t){e.loading=!0,e.dlgEditAccount.loading=!0,m.redraw();let a={method:"PUT",body:JSON.stringify({id:e.activeAccount.id,name:t.name,initialAmount:t.initialAmount})};request("/api/account",n,a).then(t=>{let n=e.accounts.findIndex(e=>e.id===t.id),a=t;e.accounts.splice(n,1,a),e.activeAccount.name=a.name,e.activeAccount.total=a.total,e.activeAccount.initialAmount=a.initialAmount}).catch(t=>{e.dlgError.message=t.message,e.dlgError.visible=!0}).finally(()=>{e.loading=!1,e.dlgEditAccount.loading=!1,e.dlgEditAccount.visible=!1,m.redraw()})}(t)},onRejected(){e.dlgEditAccount.visible=!1}}))}0===o.length&&e.dlgDeleteAccount.visible&&o.push(m(DialogConfirm,{title:"Delete Akun",message:`Yakin ingin menghapus akun "${e.activeAccount.name}" ?`,acceptText:"Ya",rejectText:"Tidak",loading:e.dlgDeleteAccount.loading,onAccepted(){!function(){e.loading=!0,e.dlgDeleteAccount.loading=!0,m.redraw();let t=`/api/account/${e.activeAccount.id}`;request(t,n,{method:"DELETE"}).then(()=>{let t=e.accounts.findIndex(t=>t.id===e.activeAccount.id);e.accounts.splice(t,1),e.activeAccount.id=0}).catch(t=>{e.dlgError.message=t.message,e.dlgError.visible=!0}).finally(()=>{e.loading=!1,e.dlgDeleteAccount.loading=!1,e.dlgDeleteAccount.visible=!1,m.redraw()})}()},onRejected(){e.dlgDeleteAccount.visible=!1}}));let c=[];e.loading&&c.push(m(LoadingCover));let l=[],r="Daftar Akun",s=[];if(!e.accountsLoading&&e.accounts.length>0){r=`Total ${t(e.accounts.reduce((e,t)=>e.plus(Number(t.total)),Big(0)))}`}s=e.accountsLoading?[m("i.fas.fa-fw.fa-spin.fa-spinner.home-list__loading-sign")]:0===e.accounts.length?[m("p.home-list__empty-message","Belum ada akun terdaftar")]:e.accounts.map(n=>{let i={};return n.id!==e.activeAccount.id&&(i.onclick=()=>{e.activeAccount=n,a()}),m(".account",i,m("p.account__name",n.name),m("p.account__amount",t(n.total)))}),l.push(m(".home-list.account-list",m(".home-list__header.account-list__header",m("p.home-list__header__title",r),m(Button,{iconOnly:!0,class:"home-list__header__button",icon:"fa-plus-circle",caption:"Akun baru",onclick(){e.dlgNewAccount.visible=!0}})),...s));let g=`${e.activeAccount.name}, ${t(e.activeAccount.total)}`,u=[];if(e.entriesLoading?u=[m("i.fas.fa-fw.fa-spin.fa-spinner.home-list__loading-sign")]:0===e.activeAccount.entries.length?u=[m("p.home-list__empty-message","Belum ada entry yang terdaftar")]:(e.activeAccount.entries.forEach((n,a)=>{let i="",o=Big(n.amount),c=n.description;if(1===n.entryType)i="entry--income";else if(2===n.entryType)i="entry--expense",o=o.times(-1);else{let t=e.activeAccount.id===n.affectedAccountId,a=t?n.accountId:n.affectedAccountId,l=e.accounts.find(e=>e.id===a),r=l?l.name:"";i="entry--transfer",t?c=`Masuk dari ${r}`:(c=`Pindah ke ${r}`,o=o.times(-1))}let l=e.activeAccount.entries[a-1];null!=l&&n.entryDate===l.entryDate||u.push(m(".entry__date",function(e){let t=e.split("-"),n=parseInt(t[0],10)||1,a=parseInt(t[1],10)||1,i=parseInt(t[2],10)||1,o="";switch(a){case 1:o="Januari";break;case 2:o="Februari";break;case 3:o="Maret";break;case 4:o="April";break;case 5:o="Mei";break;case 6:o="Juni";break;case 7:o="Juli";break;case 8:o="Agustus";break;case 9:o="September";break;case 10:o="Oktober";break;case 11:o="November";break;case 12:o="Desember"}return`${i} ${o} ${n}`}(n.entryDate))),u.push(m(".entry",m("p.entry__description",c),m("p.entry__amount",{class:i},t(o))))}),u.push(m(".entry-list__space"))),e.pagination.maxPage>1){let t={iconOnly:!0,tooltipPosition:"top",class:"entry-list__footer__button"},n={first:e.pagination.page>2,prev:e.pagination.page>1,next:e.pagination.page<e.pagination.maxPage,last:e.pagination.page<e.pagination.maxPage-1};for(const t in n)n[t]=!e.entriesLoading&&n[t];u.push(m(".entry-list__footer",m(Button,mergeObject(t,{icon:"fa-angle-double-left",caption:"Halaman pertama",enabled:n.first,onclick(){e.pagination.page=1,a()}})),m(Button,mergeObject(t,{icon:"fa-angle-left",caption:"Halaman sebelumnya",enabled:n.prev,onclick(){e.pagination.page--,a()}})),m("p.entry-list__footer__page",`${e.pagination.page} / ${e.pagination.maxPage}`),m(Button,mergeObject(t,{icon:"fa-angle-right",caption:"Halaman selanjutnya",enabled:n.next,onclick(){e.pagination.page++,a()}})),m(Button,mergeObject(t,{icon:"fa-angle-double-right",caption:"Halaman terakhir",enabled:n.last,onclick(){e.pagination.page=e.pagination.maxPage,a()}}))))}return 0!==e.activeAccount.id&&l.push(m(".home-list.entry-list",m(".home-list__header.entry-list__header",m("p.home-list__header__title",g),m(Button,{iconOnly:!0,class:"home-list__header__button",icon:"fa-pen",caption:"Edit akun",onclick(){e.dlgEditAccount.visible=!0}}),m(Button,{iconOnly:!0,class:"home-list__header__button",icon:"fa-trash-alt",caption:"Delete akun",onclick(){e.dlgDeleteAccount.visible=!0}}),m(Button,{iconOnly:!0,class:"home-list__header__button",icon:"fa-plus-circle",caption:"Tambah entry"})),...u)),m(".home",...l,...o,...c)},oncreate:function(){e.loading=!0,e.accountsLoading=!0,m.redraw(),request("/api/accounts",n).then(t=>{e.accounts=t}).catch(t=>{e.dlgError.message=t.message,e.dlgError.visible=!0}).finally(()=>{e.loading=!1,e.accountsLoading=!1,m.redraw()})}}}