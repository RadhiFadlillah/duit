import{Button,LoadingSign}from"./_components.min.js";import{mergeObject}from"../libs/utils.min.js";import{i18n}from"../i18n/i18n.min.js";export function AccountChart(){let t={chart:null,nAccount:0,needToRefresh:!1};function e(e){if(0===t.nAccount)return"#DDD";return`hsl(${Math.round(360/t.nAccount)*e},100%,40%)`}function n(t){return t>=1e12?Math.round(t/1e12)+"T":t>=1e9?Math.round(t/1e9)+"B":t>=1e6?Math.round(t/1e6)+"M":t>=1e3?Math.round(t/1e3)+"K":t}return{view:function(n){let r=n.attrs.loading,a=n.attrs.class,o=n.attrs.year,i=n.attrs.accounts,c=n.attrs.min,s=n.attrs.max,l=n.attrs.series,u=n.attrs.onYearChanged;"boolean"!=typeof r&&(r=!1),"string"!=typeof a&&(a=""),"number"!=typeof o&&(o=(new Date).getFullYear()),Array.isArray(i)||(i=[]),"number"!=typeof c&&(c=void 0),"number"!=typeof s&&(s=void 0),Array.isArray(l)||(l=[]),"function"!=typeof u&&(u=()=>{}),t.nAccount=i.length;let h=0==i.length||0==l.length,f=[];if(r?f.push(m(LoadingSign,{class:"account-chart__loading-sign"})):h?f.push(m("p.account-chart__empty-message",i18n("No chart data available"))):(f.push(m(".account-chart__header",i.map((t,n)=>m("p.account-chart__legend",m("span.account-chart__legend__color",{style:`background:${e(n)}`}),t.name)))),f.push(m(".account-chart__wrapper",m(".account-chart__content")))),!r){let e=(new Date).getFullYear(),n={iconOnly:!0,tooltipPosition:"top",class:"chart__footer__button"};f.push(m(".account-chart__footer",m(Button,mergeObject(n,{icon:"fa-angle-left",caption:i18n("Last year"),enabled:!t.loading,onclick(){u(o-1)}})),m("p.account-chart__footer__year",`${o}`),m(Button,mergeObject(n,{icon:"fa-angle-right",caption:i18n("Next year"),enabled:!t.loading&&o<e,onclick(){u(o+1)}}))))}return m(".account-chart",{class:a},f)},onupdate:function(r){let a=r.attrs.accounts,o=r.attrs.min,i=r.attrs.max,c=r.attrs.series;Array.isArray(a)||(a=[]),"number"!=typeof o&&(o=void 0),"number"!=typeof i&&(i=void 0),Array.isArray(c)||(c=[]),t.needToRefresh&&function(r,a){if(0==a.accounts.length)return;if(0==a.series.length)return;null!=t.chart&&"function"==typeof t.chart.detach&&t.chart.detach();let o=r.querySelector(".account-chart__content");if(null==o)return;let i=[i18n("Jan"),i18n("Feb"),i18n("Mar"),i18n("Apr"),i18n("May"),i18n("Jun"),i18n("Jul"),i18n("Aug"),i18n("Sep"),i18n("Oct"),i18n("Nov"),i18n("Dec")],c=a.accounts.map(t=>{let e=new Array(12).fill(null);return a.series.filter(e=>e.accountId===t.id).forEach(t=>e[t.month-1]=t.amount),e});t.chart=new Chartist.Line(o,{labels:i,series:c},{fullWidth:!0,lineSmooth:Chartist.Interpolation.none({fillHoles:!0}),chartPadding:{top:24,right:24,bottom:8,left:8},axisY:{low:void 0,high:void 0,scaleMinSpace:30,labelInterpolationFnc:n},axisX:{labelOffset:{x:-8,y:0}},plugins:[Chartist.plugins.ctPointLabels({textAnchor:"middle",labelInterpolationFnc:n})]}),t.chart.on("draw",(function(t){"line"!==t.type&&"point"!==t.type||t.element.attr({style:`stroke: ${e(t.seriesIndex)}`})})),t.needToRefresh=!1}(r.dom,{accounts:a,minValue:o,maxValue:i,series:c})},onbeforeupdate:function(e,n){let r=e.attrs.year,a=n.attrs.year,o=e.attrs.accounts,i=n.attrs.accounts,c=e.attrs.min,s=n.attrs.min,l=e.attrs.max,u=n.attrs.max,h=e.attrs.series,m=n.attrs.series;"number"!=typeof r&&(r=0),"number"!=typeof a&&(a=0),Array.isArray(o)||(o=[]),Array.isArray(i)||(i=[]),"number"!=typeof c&&(c=0),"number"!=typeof s&&(s=0),"number"!=typeof l&&(l=void 0),"number"!=typeof u&&(u=0),Array.isArray(h)||(h=[]),Array.isArray(m)||(m=[]),r===a&&c===s&&l===u&&o.length===i.length&&h.length===m.length?(m.some((t,e)=>{let n=h[e];return JSON.stringify(t)!==JSON.stringify(n)})||i.some((t,e)=>{let n=o[e];return JSON.stringify(t)!==JSON.stringify(n)}))&&(t.needToRefresh=!0):t.needToRefresh=!0}}}