import{Button,LoadingCover}from"./components/_components.min.js";import{request}from"./libs/utils.min.js";import{i18n}from"./i18n/i18n.min.js";import Cookies from"./libs/js-cookie.min.js";function registerScreen(){let e={loading:!1,name:"",username:"",password:"",repeatPassword:"",error:""};return{view:function(){let r=[];""!==e.error&&r.push(m("p.register__error",e.error));let t=[];e.loading&&t.push(m(LoadingCover));let o=i18n("Original logo by $author from $website").split(" ").map(e=>"$author"===e?m("a.attribution__link",{target:"_blank",rel:"noopener",href:"https://www.flaticon.com/authors/freepik"},"Freepik "):"$website"===e?m("a.attribution__link",{target:"_blank",rel:"noopener",href:"https://www.flaticon.com"},"www.flaticon.com "):e+" ");return m(".register",m(".register__body",...r,m(".register__form",m("img.register__logo",{src:"/res/logo.svg"}),m("p.register__title",i18n("Welcome, new user")),m("input[type=text].register__input",{value:e.name,autocomplete:"new-password",placeholder:i18n("Name"),oninput(r){e.name=r.target.value}}),m("input[type=text].register__input",{value:e.username,autocomplete:"new-password",placeholder:i18n("Username"),oninput(r){e.username=r.target.value}}),m("input[type=password].register__input",{value:e.password,autocomplete:"new-password",placeholder:i18n("Password"),oninput(r){e.password=r.target.value}}),m("input[type=password].register__input",{value:e.repeatPassword,autocomplete:"new-password",placeholder:i18n("Repeat password"),oninput(r){e.repeatPassword=r.target.value}}),m(Button,{class:"register__button",caption:i18n("Register"),loading:e.loading,onclick(){""!==e.name&&""!==e.username&&""!==e.password&&(e.password===e.repeatPassword?function(){e.loading=!0,e.error="",m.redraw();let r={method:"POST",body:JSON.stringify({name:e.name,username:e.username,password:e.password,admin:!0})};request("/api/user","5s",r).then(e=>request("/api/login","5s",{method:"POST",body:JSON.stringify({username:e.username,password:e.password})})).then(e=>{let r=e.session,t=e.user||null;Cookies.set("session-duit",r,{expires:365}),localStorage.setItem("duit-user",JSON.stringify(t)),window.location.href="/"}).catch(r=>{e.error=r.message}).finally(()=>{e.loading=!1,m.redraw()})}():e.error=i18n("new password doesn't match"))}}))),m("p.attribution",o),...t)},oncreate:function(e){e.dom.querySelector(".register__input").focus()}}}export function startApp(){m.mount(document.body,registerScreen)}